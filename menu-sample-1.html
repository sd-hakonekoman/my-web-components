<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>PC/SPメニュー別 Responsive Accessible Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gray-100 text-gray-900" data-menu-open="false">
  <!-- スキップリンク -->
  <a
    href="#main"
    class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 bg-white px-3 py-2 shadow z-[60]"
  >
    本文へスキップ
  </a>

  <header class="bg-white shadow">
    <!-- ここは「背景側」になり得る要素。メニューオープン中は inert 対象にする -->
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between gap-4">
      <div id="headerInert" class="flex items-center gap-4">
        <a href="#" class="font-semibold">Site Title</a>

        <!-- PC時の補助リンク例（オープン中 inert にしたいケース） -->
        <a href="#" class="hidden sm:inline text-sm text-gray-600 hover:underline">Help</a>
      </div>

      <!-- 開閉ボタン（SPのみ表示） -->
      <button
        type="button"
        id="menuButton"
        class="md:hidden inline-flex items-center justify-center rounded p-2
               focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
        aria-controls="siteNav"
        aria-expanded="false"
      >
        <!-- span 3本線 → × アニメ -->
        <span class="relative block h-5 w-6" aria-hidden="true">
          <span
            class="absolute left-0 top-0 block h-0.5 w-6 bg-current transition-transform transition-opacity duration-200
                   data-[open=true]:translate-y-2 data-[open=true]:rotate-45"
            data-icon="line1"
          ></span>
          <span
            class="absolute left-0 top-2 block h-0.5 w-6 bg-current transition-opacity duration-200
                   data-[open=true]:opacity-0"
            data-icon="line2"
          ></span>
          <span
            class="absolute left-0 top-4 block h-0.5 w-6 bg-current transition-transform transition-opacity duration-200
                   data-[open=true]:-translate-y-2 data-[open=true]:-rotate-45"
            data-icon="line3"
          ></span>
        </span>

        <span class="sr-only" id="menuButtonLabel">メニューを開く</span>
      </button>

      <!-- PC用ナビ（横並び） -->
      <nav class="hidden md:block" aria-label="グローバルナビゲーション">
        <ul class="flex items-center gap-6 text-sm">
          <li><a class="hover:underline" href="#">About</a></li>
          <li><a class="hover:underline" href="#">Works</a></li>
          <li><a class="hover:underline" href="#">Contact</a></li>
        </ul>
      </nav>
    </div>

    <!-- SP用：オーバーレイ + オフキャンバスナビ（header 内に設置） -->
    <!-- overlay -->
    <div
      id="menuOverlay"
      class="md:hidden fixed inset-0 z-40 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-200"
      aria-hidden="true"
    ></div>

    <!-- offcanvas nav -->
    <nav
      id="siteNav"
      class="md:hidden fixed inset-y-0 right-0 z-50 w-80 max-w-[90vw] bg-white shadow-xl
             translate-x-full transition-transform duration-200
             flex flex-col"
      aria-label="グローバルナビゲーション"
      hidden
    >
      <div class="p-4 border-b flex items-center justify-between">
        <h2 class="text-base font-semibold">メニュー</h2>
        <!-- 閉じるはボタン共通にしているので、ここに独立ボタンは置かない前提 -->
        <!-- ただしUI的に必要なら置いてよい（アクセシビリティ的には問題なし） -->
      </div>

      <!-- 項目増加を想定：メニュー内スクロール -->
      <div class="flex-1 overflow-y-auto p-4">
        <ul class="space-y-2">
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">About</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Works</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Contact</a></li>

          <!-- ダミー（増える想定） -->
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 04</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 05</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 06</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 07</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 08</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 09</a></li>
          <li><a class="block rounded px-2 py-2 hover:bg-gray-100" href="#">Item 10</a></li>
        </ul>
      </div>

      <div class="p-4 border-t text-sm text-gray-600">
        フッター要素などを置く場合はここに。
      </div>
    </nav>
  </header>

  <!-- 背景側（inert 対象） -->
  <main id="main" tabindex="-1" class="mx-auto max-w-5xl p-4" data-inert-target="true">
    <p class="mb-4">
      Tab / Shift+Tab / Escape / クリックで挙動を確認できます。SP幅でのみオフキャンバスが動作します。
    </p>
    <a href="#" class="inline-block rounded bg-white px-3 py-2 shadow hover:bg-gray-50">
      背景のリンク（メニューオープン中は操作不可にする）
    </a>
    <p class="mt-5">Lorem ipsum dolor sit, amet consectetur adipisicing elit. Autem eius modi fugiat dicta cumque accusamus recusandae illum aperiam minima dignissimos amet ullam ut odio tempora aut reprehenderit libero, veniam voluptatum! Vitae saepe excepturi beatae architecto ipsum iusto expedita, tenetur placeat et non cumque corporis enim veniam eos labore odit aperiam voluptas autem suscipit, ducimus ad? Ratione voluptas praesentium qui. Quod mollitia temporibus praesentium ipsa tenetur in magnam repellat. A quisquam ipsum hic harum incidunt voluptatem alias earum ipsam! Natus ad iure cum sapiente deserunt repellendus omnis inventore ullam modi magnam assumenda aut blanditiis ut porro molestiae facere eos, voluptates voluptate nulla distinctio? Voluptates saepe aliquam similique, praesentium a vel obcaecati architecto cupiditate iste incidunt, odio placeat, adipisci exercitationem alias laboriosam quisquam distinctio esse illo ex voluptate. Molestias eligendi deserunt vero fuga ex nisi quisquam voluptates veniam alias magni natus suscipit quo reiciendis tempore, provident expedita minima at nobis, libero numquam ut! Dolores nostrum facere culpa quidem doloremque ab labore obcaecati possimus. Debitis illum quis perspiciatis veniam voluptatem nemo hic ullam quasi ipsam. Iure quidem facere voluptate expedita doloremque voluptates architecto exercitationem earum nobis odio, corporis laboriosam cupiditate ipsa pariatur! Debitis neque optio architecto expedita at tenetur, nostrum sequi voluptatem ipsum error. Beatae quasi suscipit, labore voluptate asperiores itaque reprehenderit aliquam, at exercitationem ipsam et cupiditate consectetur eligendi minus repellat iure cum dolores ipsa quisquam deleniti eveniet. Ex pariatur quis nobis animi ipsum nesciunt, sequi possimus aspernatur porro autem, repudiandae architecto temporibus quidem soluta quod, accusantium consequatur voluptates quae quasi obcaecati. Fuga labore atque architecto, praesentium iusto facere perferendis inventore autem eius nihil tempore? Iusto similique harum explicabo ipsum doloremque maiores qui doloribus reiciendis aliquid consequuntur. Odio commodi quo autem sed molestias ex, culpa corporis. Sequi, aperiam veniam. A illum explicabo ducimus numquam velit neque excepturi quasi exercitationem optio qui sunt ullam maiores, delectus quidem voluptas assumenda molestias esse? Aperiam nisi quas ratione, repudiandae perspiciatis odio velit? Ratione, et? Quod repudiandae sint deserunt accusantium cumque doloribus, possimus dignissimos quaerat, eos earum ad minima saepe deleniti animi dolore hic optio, inventore fugiat soluta? Eveniet eius odio quisquam dolorem exercitationem expedita? Ea repudiandae voluptas, sed fugiat tempore totam saepe eveniet doloremque veritatis. Ratione blanditiis excepturi suscipit facilis cumque dolore maiores quaerat voluptas earum autem explicabo nobis unde aliquam atque quos ex laudantium, cupiditate fugiat nulla corrupti dicta adipisci quis libero minus. Nulla accusantium, repudiandae consequuntur, rem impedit debitis numquam sequi officiis eos explicabo accusamus iste nostrum in reprehenderit nihil maxime voluptates amet a culpa. Dolore aut harum et exercitationem aliquid ea dignissimos doloremque blanditiis ipsum. Voluptatibus fugit, eaque impedit possimus, tempora iste praesentium consequuntur hic nihil ducimus deserunt culpa dignissimos amet. A laborum dolores officiis quo quibusdam saepe aliquid iste ullam quam itaque quidem dolorum magnam accusantium nobis consequuntur, unde dolorem velit repellat? Eveniet voluptas quam nostrum delectus natus magni ipsa vel fuga officia necessitatibus commodi, quae omnis odio incidunt. Alias fugit iusto reiciendis dicta ducimus consequatur quos, dolor distinctio error saepe voluptates quidem ex? Deserunt reprehenderit debitis odit accusantium dolores repellendus laudantium. Aut molestiae ab sed ut nesciunt facilis iure dolore distinctio eligendi autem, possimus soluta maiores doloribus? Vel perferendis fuga voluptatum animi corrupti molestias debitis assumenda tempore! Dolorum, ea nesciunt deserunt ratione quia, ullam assumenda tempore, atque quisquam reprehenderit architecto ex minima explicabo delectus? Qui voluptatem earum sapiente expedita numquam commodi a adipisci quisquam, ex fugiat dolorem corporis vel fugit modi quasi blanditiis itaque animi est voluptate voluptas magni in odio sint iure. Eaque cum corrupti natus esse beatae repudiandae omnis laudantium corporis reprehenderit, totam aspernatur animi ducimus fuga minima, perferendis tempora saepe modi eligendi nisi. Nobis corrupti provident eligendi amet minus vel fuga sed deleniti ea illum delectus maxime facere, tempore blanditiis, error sit laudantium minima assumenda modi inventore doloribus. Veritatis, harum repudiandae a commodi deleniti alias maiores quam quas expedita repellat voluptates eligendi dicta nemo quisquam ipsum corporis eius numquam. Quo tenetur quasi ea dignissimos recusandae quaerat modi, optio soluta doloribus facere sunt tempora beatae id dolore consequatur possimus adipisci consectetur consequuntur animi esse dolorum, asperiores placeat incidunt non? Incidunt amet perspiciatis facere corporis officia. Dicta dolor suscipit aliquid mollitia aliquam illum, magni est quos libero ad quisquam omnis quibusdam consequatur quod distinctio aperiam dolorem laborum itaque. Voluptatem, quidem cum deleniti totam perferendis fuga recusandae, impedit mollitia iste doloribus, atque eveniet fugit itaque eos numquam dolorum ipsa placeat tempora soluta labore. Perspiciatis ducimus iure, culpa doloribus sunt odit, odio, assumenda quo dolor explicabo expedita illum itaque ratione voluptates? Sequi aperiam magnam consectetur quidem culpa ipsum doloribus sunt quia minus vero assumenda aspernatur id optio architecto voluptates ad nobis sapiente debitis est ut consequuntur unde, deleniti, eaque tempora? Minus ipsam totam molestias esse hic cum adipisci repellat consequuntur quo, ad, quas laboriosam, mollitia tempore fugiat aperiam tempora cupiditate molestiae soluta at cumque. Possimus molestiae quibusdam est consequuntur incidunt quam laborum rem, minus illo at suscipit sit. Debitis odit similique accusantium blanditiis, iusto nemo repellendus in illum inventore sit est voluptas qui autem nobis earum quae rerum quas quos ad repellat soluta officia suscipit pariatur. Laudantium quod temporibus ad voluptate. Cupiditate quo obcaecati, similique ipsam modi, architecto ut corrupti pariatur deserunt beatae exercitationem non sunt expedita eius recusandae cum animi dolore ullam suscipit quaerat atque accusamus fuga? Odio eos tempora explicabo, asperiores facilis amet consequatur? Eos dolorem optio rerum velit deleniti dolore illo sapiente officiis amet beatae quae delectus consectetur obcaecati, eaque similique cupiditate excepturi placeat aliquam corrupti exercitationem. Officiis nostrum pariatur provident nesciunt est repellendus non porro recusandae incidunt voluptatem esse modi quod, deleniti distinctio reiciendis eaque. Eligendi odio quis ipsum officiis quae, voluptates ratione doloremque obcaecati facilis, maxime in veniam delectus perspiciatis quam hic quisquam. Ad suscipit minus maxime amet eius itaque illum fugit dicta eum, ex, autem nihil est quaerat laudantium deleniti, nisi reprehenderit ipsam? Iure, porro doloremque. Ipsum vitae adipisci inventore nostrum expedita nihil libero necessitatibus debitis placeat saepe dolore dolorem magnam praesentium quo laboriosam est, unde quisquam sequi alias blanditiis suscipit doloremque cum recusandae. Incidunt aliquid a itaque assumenda nobis voluptatum repellat quos amet quas cumque?</p>
  </main>

  <footer class="mx-auto max-w-5xl p-4 text-sm text-gray-700" data-inert-target="true">
    <a href="#" class="hover:underline">Footer Link</a>
  </footer>

  <script>
    (() => {
      const body = document.body;

      const button = document.getElementById("menuButton");
      const label = document.getElementById("menuButtonLabel");
      const nav = document.getElementById("siteNav");
      const overlay = document.getElementById("menuOverlay");

      // inert 対象：main/footerに加え、header内の「ボタン以外」を個別に指定
      const headerInert = document.getElementById("headerInert");
      const inertTargets = [
        headerInert,
        ...document.querySelectorAll("[data-inert-target='true']")
      ].filter(Boolean);

      // SPのみ挙動を有効化（Tailwindの md に合わせて 768px を採用）
      const mq = window.matchMedia("(min-width: 768px)");

      let lastFocused = null;
      let scrollY = 0;

      const setIconState = (open) => {
        const lines = button.querySelectorAll("[data-icon]");
        lines.forEach((el) => el.dataset.open = open ? "true" : "false");
      };

      const setInert = (on) => {
        inertTargets.forEach((el) => {
          if (!el) return;
          if ("inert" in el) {
            el.inert = on;
          } else {
            // フォールバック：SRの読み上げ抑制（※フォーカス抑制にはならないため、フォーカストラップ必須）
            if (on) el.setAttribute("aria-hidden", "true");
            else el.removeAttribute("aria-hidden");
          }
        });
      };

      // iOS含め比較的安全なスクロールロック
      const lockScroll = () => {
        scrollY = window.scrollY;
        document.body.style.position = "fixed";
        document.body.style.top = `-${scrollY}px`;
        document.body.style.left = "0";
        document.body.style.right = "0";
        document.body.style.width = "100%";
      };

      const unlockScroll = () => {
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        window.scrollTo(0, scrollY);
      };

      const getFocusable = (root) => {
        const selectors = [
          "a[href]",
          "button:not([disabled])",
          "input:not([disabled])",
          "select:not([disabled])",
          "textarea:not([disabled])",
          "[tabindex]:not([tabindex='-1'])"
        ];
        return Array.from(root.querySelectorAll(selectors.join(",")))
          .filter((el) => !el.hasAttribute("hidden") && el.offsetParent !== null);
      };

      const openMenu = () => {
        if (mq.matches) return; // PC幅では動作させない

        lastFocused = document.activeElement;

        body.dataset.menuOpen = "true";
        button.setAttribute("aria-expanded", "true");
        label.textContent = "メニューを閉じる";
        setIconState(true);

        nav.hidden = false;

        // アニメ開始：overlay/navを表示状態へ
        overlay.classList.remove("pointer-events-none");
        overlay.classList.add("opacity-100");

        nav.classList.remove("translate-x-full");
        nav.classList.add("translate-x-0");

        setInert(true);
        lockScroll();

        // フォーカス移動（nav内の最初へ）
        const focusables = getFocusable(nav);
        (focusables[0] ?? nav).focus?.();
      };

      const closeMenu = () => {
        body.dataset.menuOpen = "false";
        button.setAttribute("aria-expanded", "false");
        label.textContent = "メニューを開く";
        setIconState(false);

        // アニメで閉じる
        overlay.classList.add("pointer-events-none");
        overlay.classList.remove("opacity-100");

        nav.classList.add("translate-x-full");
        nav.classList.remove("translate-x-0");

        setInert(false);
        unlockScroll();

        // トランジション後に hidden を戻す（安全に）
        const durationMs = 200;
        window.setTimeout(() => {
          nav.hidden = true;
        }, durationMs);

        (lastFocused ?? button).focus();
        lastFocused = null;
      };

      const toggleMenu = () => {
        const expanded = button.getAttribute("aria-expanded") === "true";
        expanded ? closeMenu() : openMenu();
      };

      // クリック
      button.addEventListener("click", toggleMenu);
      overlay.addEventListener("click", () => {
        if (button.getAttribute("aria-expanded") === "true") closeMenu();
      });

      // キーボード：Esc + フォーカストラップ
      document.addEventListener("keydown", (e) => {
        const isOpen = button.getAttribute("aria-expanded") === "true";
        if (!isOpen) return;

        if (e.key === "Escape") {
          e.preventDefault();
          closeMenu();
          return;
        }

        if (e.key !== "Tab") return;

        const focusables = getFocusable(nav);
        if (focusables.length === 0) {
          e.preventDefault();
          return;
        }

        const first = focusables[0];
        const last = focusables[focusables.length - 1];

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      });

      // メニュー内リンククリックで閉じる（SPでは一般的）
      nav.addEventListener("click", (e) => {
        const a = e.target.closest("a[href]");
        if (!a) return;
        closeMenu();
      });

      // PC幅に切り替わったら状態を強制リセット（重要）
      const resetIfDesktop = () => {
        if (!mq.matches) return;
        // PCではオフキャンバスは使わないので強制クローズ
        if (button.getAttribute("aria-expanded") === "true") closeMenu();

        // 念のため表示状態も初期化
        nav.hidden = true;
        overlay.classList.add("pointer-events-none");
        overlay.classList.remove("opacity-100");
        nav.classList.add("translate-x-full");
        nav.classList.remove("translate-x-0");
        setIconState(false);
      };

      mq.addEventListener("change", resetIfDesktop);
      resetIfDesktop();
    })();
  </script>
</body>
</html>
